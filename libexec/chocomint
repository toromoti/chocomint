#!/usr/bin/env bash

_CHM_NAME='chocomint.sh'
_CHM_VERSION='0.3.0-dev'

export _CHM_TARGET_FULLPATH="$(readlink -f -- "$1")"
export _CHM_LIBEXEC="$(dirname -- "$(readlink -f -- "${BASH_SOURCE:-$0}")")"

source ${_CHM_LIBEXEC}/chocomint-lib/outputs

export _CHM_TEST_RESULTS_FILE="/tmp/_chm_test_results.$$"

# variables in _CHM_TEST_RESULTS_FILE
export _CHM_TEST_FAILURE=0
export _CHM_TEST_SUCCESS=0
export _CHM_TEST_COUNT=0
export _CHM_CMD_SUCCESS=0
export _CHM_CMD_COUNT=0
export _CHM_FAILURE=false


_chm_first_check() {
  #
  # "tput" exist check
  #
  if type tput > /dev/null 2>&1
  then
    export _CHM_TPUT="tput"
  else
    echo "WARN: \"tput\" command is not found"
    echo "WARN: run without coloring"
    echo
    export _CHM_TPUT="true"
  fi

  #
  # "bc" exist check
  #
  if type bc > /dev/null 2>&1
  then
    export _CHM_BC_COMMAND_EXIST=true
  else
    echo "WARN: \"bc\" command is not found"
    echo "WARN: unable to display the execution time of commands"
    echo
    export _CHM_BC_COMMAND_EXIST=false
  fi
}


_chm_file_check() {
  # $1 target fullpath

  [ "$1" ] || {
    echo "No target file"
    exit 2
  }

  [ -f "$1" ] || {
    echo "No such a file: $1"
    exit 3
  }
}


_chm_main() {
  # $1 target fullpath

  _chm_first_check

  _chm_outputs.title "${_CHM_NAME} ${_CHM_VERSION}"

  _chm_file_check "$1"

  ${_CHM_LIBEXEC}/chocomint-main "$1"

  [ -f "${_CHM_TEST_RESULTS_FILE}" ] && {
    source ${_CHM_TEST_RESULTS_FILE}
    rm ${_CHM_TEST_RESULTS_FILE}
  }

  _chm_outputs.overall_results \
    "${_CHM_TEST_FAILURE}"     \
    "${_CHM_TEST_SUCCESS}"     \
    "${_CHM_TEST_COUNT}"       \
    "${_CHM_CMD_SUCCESS}"      \
    "${_CHM_CMD_COUNT}"

  ${_CHM_FAILURE} && return 1 || return 0
}

_chm_main "${_CHM_TARGET_FULLPATH}"
