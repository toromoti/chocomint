#!/usr/bin/env bash

#set -x # debug mode
#set -n # syntax check
ROOT="$(dirname -- "$(readlink -f -- "${BASH_SOURCE:-$0}")")"/..
echo $ROOT

declare -a DEF_COMMENT_LINENUM   # テストコメントがある行番号
declare -a TEST_COMMENT_LINENUM   # テストコメントがある行番号
declare -a TEST_COMMENT_STYLE           # 行番号 -> テストコメントの有無(true or false)
declare -a TEST_COMMENT_HASH      # 行番号 -> テストコメントの内容
declare -i LINENUM=1
declare TEST_COMMENT
declare PARSE_METHOD

PARSE_METHOD="parse_nl"

parse_def_comments() {
  case $1 in
    "" )
      DEF_COMMENT_LINENUM+=( "$LINENUM" )
      PARSE_METHOD="parse_nl"
      LINENUM+=1
      DEF_COMMENT=""
      ;;
    * )
      DEF_COMMENT="$DEF_COMMENT$1"
      ;;
  esac
}

parse_test_comments() {
  case $1 in
    ":" )
      PARSE_METHOD="parse_def_comments"
      ;;
    "" )
      TEST_COMMENT_LINENUM+=( "$LINENUM" )
      if [ "$COMMENT_IN" = "NL" ]; then
        TEST_COMMENT_STYLE[LINENUM]="NL"
      else
        TEST_COMMENT_STYLE[LINENUM]="EOL"
      fi; unset COMMENT_IN
      TEST_COMMENT_HASH[LINENUM]="$TEST_COMMENT"
      PARSE_METHOD="parse_nl"
      LINENUM+=1
      TEST_COMMENT=""
      ;;
    * )
      TEST_COMMENT="$TEST_COMMENT$1"
      ;;
  esac
}

parse_hash() {
  case $1 in
    ":" )
      PARSE_METHOD="parse_test_comments"
      ;;
    "" )
      LINENUM+=1
      PARSE_METHOD="parse_nl"
      ;;
    * )
      PARSE_METHOD="parse_main"
      ;;
  esac
}

parse_dq_bs() {
  case $1 in
    "" )
      LINENUM+=1
      PARSE_METHOD="parse_dq"
      ;;
    * )
      PARSE_METHOD="parse_dq"
      ;;
  esac
}

parse_dq() {
  case $1 in
    "\\" )
      PARSE_METHOD="parse_dq_bs"
      ;;
    '"' )
      PARSE_METHOD="parse_main"
      ;;
    "" )
      LINENUM+=1
      ;;
    * )
      :
      ;;
  esac
}

parse_sq_bs() {
  case $1 in
    "" )
      LINENUM+=1
      PARSE_METHOD="parse_sq"
      ;;
    * )
      PARSE_METHOD="parse_sq"
      ;;
  esac
}

parse_sq() {
  case $1 in
    "\\" )
      PARSE_METHOD="parse_sq_bs"
      ;;
    "'" )
      PARSE_METHOD="parse_main"
      ;;
    "" )
      LINENUM+=1
      ;;
    * )
      :
      ;;
  esac
}

parse_bs() {
  case $1 in
    "" )
      LINENUM+=1
      PARSE_METHOD="parse_main"
      ;;
    * )
      PARSE_METHOD="parse_main"
      ;;
  esac
}

parse_main() {
  case $1 in
    "#" )
      PARSE_METHOD="parse_hash"
      ;;
    "\\" )
      PARSE_METHOD="parse_bs"
      ;;
    "'" )
      PARSE_METHOD="parse_sq"
      ;;
    '"' )
      PARSE_METHOD="parse_dq"
      ;;
    "" )
      LINENUM+=1
      PARSE_METHOD="parse_nl"
      ;;
    * )
      ;;
  esac
}

parse_nl_space() {
  case $1 in
    "#" )
      PARSE_METHOD="parse_hash"
      COMMENT_IN="NL"
      ;;
    " "|"\t" )
      PARSE_METHOD="parse_nl_space"
      ;;
    "\\" )
      PARSE_METHOD="parse_bs"
      ;;
    "'" )
      PARSE_METHOD="parse_sq"
      ;;
    '"' )
      PARSE_METHOD="parse_dq"
      ;;
    "" )
      LINENUM+=1
      PARSE_METHOD="parse_nl"
      ;;
    * )
      PARSE_METHOD="parse_main"
      ;;
  esac
}

parse_nl() {
  case $1 in
    "#" )
      PARSE_METHOD="parse_hash"
      COMMENT_IN="NL"
      ;;
    " "|"\t" )
      PARSE_METHOD="parse_nl_space"
      ;;
    "\\" )
      PARSE_METHOD="parse_bs"
      ;;
    "'" )
      PARSE_METHOD="parse_sq"
      ;;
    '"' )
      PARSE_METHOD="parse_dq"
      ;;
    "" )
      LINENUM+=1
      PARSE_METHOD="parse_nl"
      ;;
    * )
      PARSE_METHOD="parse_main"
      ;;
  esac
}

main() {
  local file=$1
  local line
  local char

  while IFS= read -r line; do
    while IFS= read -r -n 1 char; do
      $PARSE_METHOD "$char"
    done < <(echo $line)
  done < $file
}

main "$@"

declare -p TEST_COMMENT_HASH
echo ------------
declare -p TEST_COMMENT_LINENUM
echo ------------
declare -p TEST_COMMENT_STYLE
echo ------------
declare -p BASH_SOURCE
echo ------------

declare -A HASH__
declare -i LINENO_CACHE=0
declare COMMAND_CACHE
declare -i LIST_INDEX=0
#set -x
#set -v

catch_execution() {
  [ "$2" = "$TARGET_FULLPATH" ] && {
    tput setaf 1 >&3
    echo " * $1 $BASH_COMMAND" >&3
    tput setaf 7 >&3
    if [ "${TEST_COMMENT_STYLE[$1]}" = "EOL" ]; then
      eval "echo \"==> ${TEST_COMMENT_HASH[$1]}\" >&3"
    elif [ "${TEST_COMMENT_STYLE[$(($1+1))]}" = "NL" ]; then
      eval "echo \"==> ${TEST_COMMENT_HASH[$(($1+1))]}\" >&3"
    fi
  }
}

preprocess() {
  set -E
  set -T
  out=3
  eval "exec $out>&1 4>&2 1> std.log 2> err.log"
  trap 'catch_execution "$LINENO" "$BASH_SOURCE"' DEBUG
}

postprocess() {
  trap DEBUG
  exec 1>&3- 2>&4-
  set +E
  set +T
}

runtest() {
  TARGET_FULLPATH="$(readlink -f -- "$1")"
  preprocess
  . "$TARGET_FULLPATH"
  postprocess
}

runtest $1
