#!/bin/bash
# vim: ft=sh

_chocomint_motd() {
  echo '  __ _  _ __  __ __ __  __ __ _  _ ____  ___ _  _'
  echo ' / _( )( /  \/ _/  (  \/  (  ( \( (_  _)/ __( )( )'
  echo '( (_ )__( ()( (( () )    ( )( )  (  )( _\__ \)__('
  echo ' \__(_)(_\__/\__\__(_/\/\_(__(_)\_)(__(_(___(_)(_)'
  echo 'Minimal, simple, easy, comment-based Testing Framework for Bash 4.x'
}

_chocomint_tput_echo() {
  case $1 in
    [0-7] )
      _chocomint_tput setaf "$1"
      ;;
    'bold' )
      _chocomint_tput bold
      ;;
  esac
  _chocomint_echo "${@:2}"
  _chocomint_tput sgr0
}

_chocomint_echo() {
  echo "$@" >&3
}

_chocomint_cat() {
  cat "$@" >&3
}

_chocomint_tput() {
  tput "$@" >&3
}

_chocomint_print_judgement() {
  # $1 label tput color
  # $2 label string
  # $3 left
  # $4 mid
  # $5 right
  # $6 exitstat
  local _chocomint_tput_opt="5"
  _chocomint_tput_echo "$1" -n "$2" # 'ok' or 'ng'
  case $3 in
    'status' )
      case $4 in
        ':' )
          _chocomint_echo -n "return "
          _chocomint_tput_echo "$_chocomint_tput_opt" -n "$6"
          _chocomint_echo -n " should be "
          _chocomint_tput_echo "$_chocomint_tput_opt" "$5"
          ;;
        '!:' )
          _chocomint_echo -n "return "
          _chocomint_tput_echo "$_chocomint_tput_opt" -n "$6"
          _chocomint_echo -n " should not be "
          _chocomint_tput_echo "$_chocomint_tput_opt" "$5"
          ;;
      esac
      ;;
    'match' )
      case $4 in
        ':' )
          _chocomint_echo -n "match '"
          _chocomint_tput_echo "$_chocomint_tput_opt" -n "$5"
          _chocomint_echo "'"
          ;;
        '!:' )
          _chocomint_echo -n "not match '"
          _chocomint_tput_echo "$_chocomint_tput_opt" -n "$5"
          _chocomint_echo "'"
          ;;
      esac
      ;;
    * ) # judge variables
      case $4 in
        '=' )
          _chocomint_echo -n "value '"
          _chocomint_tput_echo "$_chocomint_tput_opt" -n "$3"
          _chocomint_echo -n "' should be '"
          _chocomint_tput_echo "$_chocomint_tput_opt" -n "$5"
          _chocomint_echo "'"
          ;;
        '!=' )
          _chocomint_echo -n "value '"
          _chocomint_tput_echo "$_chocomint_tput_opt" -n "$3"
          _chocomint_echo -n "' should not be '"
          _chocomint_tput_echo "$_chocomint_tput_opt" -n "$5"
          _chocomint_echo "'"
          ;;
      esac
      ;;
  esac
}

_chocomint_ok() {
  # $1 left
  # $2 mid
  # $3 right
  # $4 exitstat
  _chocomint_print_judgement "2" "   ✔ " "$@"
}

_chocomint_ng() {
  # $1 left
  # $2 mid
  # $3 right
  # $4 exitstat
  _chocomint_print_judgement "1" "   ✘ " "$@"
}

_chocomint_display_if_failed() {
  if $1; then
    _chocomint_echo "failed. then, display 'stdout' and 'stderr'."
    if [ -s "$_CHOCOMINT_CMD_OUT" ] || [ -s "$_CHOCOMINT_CMD_ERR" ]; then
      if [ -s "$_CHOCOMINT_CMD_OUT" ]; then
        _chocomint_tput_echo bold '``` stdout'
        _chocomint_cat $_CHOCOMINT_CMD_OUT
        _chocomint_tput sgr0 # for reset previous output attributes
        _chocomint_tput_echo bold '```'
      else
        _chocomint_echo "'stdout' is nothing."
      fi
      if [ -s "$_CHOCOMINT_CMD_ERR" ]; then
        _chocomint_tput_echo bold '``` stderr'
        _chocomint_cat $_CHOCOMINT_CMD_ERR
        _chocomint_tput sgr0 # for reset previous output attributes
        _chocomint_tput_echo bold '```'
      else
        _chocomint_echo "'stderr' is nothing."
      fi
    else
      _chocomint_tput_echo bold "but, output is nothing."
    fi
  else
    _chocomint_echo "succeeded."
    ((_CHOCOMINT_CMD_SUCCESS++))
  fi
}

_chocomint_show_overall() {
  tput bold
  tput setaf 6
  echo "$1 tests failed."
  echo "$2/$3 tests," \
       "$4/$5 command-executions succeeded."
  tput sgr0
}

_chocomint_show_command() {
  _chocomint_tput bold
  _chocomint_tput setaf 3
  _chocomint_echo "=> $1"
  _chocomint_tput sgr0
}
